<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Status - WebStamp.my</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 2rem;
      text-align: center;
    }
    
    .status-icon {
      font-size: 80px;
      margin-bottom: 1.5rem;
      animation: bounce 1s ease infinite alternate;
    }
    
    h1 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #1f2937;
    }
    
    #statusMessage {
      font-size: 1.1rem;
      color: #6b7280;
      margin-bottom: 2rem;
      line-height: 1.6;
    }
    
    .btn {
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      margin: 5px;
    }
    
    .btn-primary {
      background-color: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }
    
    .btn-secondary {
      background-color: #6b7280;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #4b5563;
      transform: translateY(-2px);
    }
    
    .btn-danger {
      background-color: #dc2626;
      color: white;
    }
    
    .btn-danger:hover {
      background-color: #b91c1c;
      transform: translateY(-2px);
    }
    
    .btn-warning {
      background-color: #f59e0b;
      color: white;
    }
    
    .btn-warning:hover {
      background-color: #d97706;
      transform: translateY(-2px);
    }
    
    .status-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 1.75rem;
      margin: 2.5rem 0;
      border-left: 5px solid #e5e7eb;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      text-align: left;
    }
    
    .status-card.success { 
      border-left-color: #10b981; 
      background: #f0fdf4;
    }
    
    .status-card.failed { 
      border-left-color: #dc2626; 
      background: #fef2f2;
    }
    
    .status-card.pending { 
      border-left-color: #f59e0b; 
      background: #fffbeb;
    }
    
    .detail-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .detail-item:last-child {
      border-bottom: none;
    }
    
    .detail-item span:first-child {
      font-weight: 500;
      color: #4b5563;
    }
    
    .detail-item span:last-child {
      font-weight: 600;
      color: #1f2937;
    }
    
    .footer {
      margin-top: 3rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e5e7eb;
      color: #9ca3af;
      font-size: 0.9rem;
    }
    
    .footer a {
      color: #6366f1;
      text-decoration: none;
      font-weight: 500;
    }
    
    .footer a:hover {
      text-decoration: underline;
    }
    
    .data-warning {
      background: #fff7ed;
      border: 1px solid #fed7aa;
      border-radius: 8px;
      padding: 1rem;
      margin: 1.5rem 0;
      color: #9a3412;
      font-size: 0.95rem;
    }
    
    .debug-info {
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      font-family: monospace;
      font-size: 0.85rem;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    
    .debug-toggle {
      background: transparent;
      border: 1px solid #d1d5db;
      color: #6b7280;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      margin: 0.5rem 0;
    }
    
    .debug-toggle:hover {
      background: #f3f4f6;
    }
    
    @keyframes bounce {
      from { transform: translateY(0px); }
      to { transform: translateY(-10px); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @media (max-width: 640px) {
      .container {
        padding: 1.5rem;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .status-icon {
        font-size: 60px;
      }
      
      .btn {
        width: 100%;
        margin: 5px 0;
      }
      
      .status-card {
        padding: 1.25rem;
      }
      
      .detail-item {
        flex-direction: column;
        gap: 0.25rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Status will be dynamically set -->
    <div class="status-icon" id="statusIcon">‚è≥</div>
    <h1 id="statusTitle">Processing Payment...</h1>
    <p id="statusMessage">Checking payment status...</p>
    
    <!-- Debug toggle -->
    <button class="debug-toggle" onclick="toggleDebug()">üîç Show Debug Info</button>
    <div id="debugInfo" class="debug-info"></div>
    
    <!-- Order Details Card -->
    <div class="status-card" id="statusCard">
      <div class="detail-item">
        <span>Order Reference:</span>
        <span style="font-family: monospace; font-weight: 600;" id="orderRef">Loading...</span>
      </div>
      <div class="detail-item">
        <span>Customer Email:</span>
        <span id="customerEmail">Loading...</span>
      </div>
      <div class="detail-item">
        <span>Amount:</span>
        <span style="font-weight: 600;" id="amount">Loading...</span>
      </div>
      <div class="detail-item">
        <span>Status:</span>
        <span id="statusText">Loading...</span>
      </div>
      <div class="detail-item">
        <span>Data Source:</span>
        <span id="dataSource">Loading...</span>
      </div>
    </div>
    
    <!-- Success actions -->
    <div id="successActions" style="display: none;">
      <button onclick="downloadHDStamp()" class="btn btn-primary">
        ‚¨áÔ∏è Download HD Stamp Now
      </button>
      <button onclick="sendToEmail()" class="btn btn-secondary">
        üìß Send to Email
      </button>
      <a href="index.html" class="btn" style="background: #9ca3af; color: white;">
        ‚Üê Back to Home
      </a>
    </div>
    
    <!-- Failed actions -->
    <div id="failedActions" style="display: none;">
      <button onclick="retryPayment()" class="btn btn-danger">
        üîÑ Retry Payment
      </button>
      <a href="index.html" class="btn btn-secondary">
        ‚Üê Back to Home
      </a>
    </div>
    
    <!-- Pending actions -->
    <div id="pendingActions" style="display: none;">
      <p style="color: #6b7280; margin-bottom: 1.5rem;">
        Your payment is being processed. This may take a few minutes.
        <br>This page will automatically update.
      </p>
      <button onclick="checkStatus()" class="btn btn-warning">
        üîÑ Check Status Again
      </button>
      <a href="index.html" class="btn btn-secondary">
        ‚Üê Back to Home
      </a>
    </div>
    
    <!-- Error actions -->
    <div id="errorActions" style="display: none; margin-top: 2rem;">
      <div class="data-warning">
        <strong>‚ö†Ô∏è Data Issue:</strong> Payment successful but stamp data was not recovered.
        <br>Please contact support with your Order Reference above.
      </div>
      <button onclick="contactSupport()" class="btn btn-danger">
        üìû Contact Support
      </button>
      <a href="index.html" class="btn btn-secondary">
        ‚Üê Back to Home
      </a>
    </div>
    
    <div class="footer">
      <p>
        Need help? <a href="mailto:support@webstamp.my">Contact Support</a>
        <br><small>WebStamp.my | Secure HD Stamp Generator</small>
      </p>
    </div>
  </div>

  <script>
    // Global variables
    let currentStampData = null;
    let currentOrderRef = null;
    let debugMode = false;
    let autoDownloadAttempted = false;

    // =============================================
    // DATA RECOVERY FUNCTIONS
    // =============================================

    function extractStampData() {
      const urlParams = new URLSearchParams(window.location.search);
      
      // Get URL parameters from BCL redirect
      const orderRef = urlParams.get('order') || urlParams.get('order_number');
      const amount = urlParams.get('amount') || '3.00';
      const status = urlParams.get('status') || 'pending';
      const reason = urlParams.get('reason') || '';
      
      console.log('üîç BCL Redirect Parameters:', { orderRef, status, amount });
      
      let stampData = null;
      let dataSource = 'not_found';
      
      // METHOD 1: Get from sessionStorage (our primary method)
      if (orderRef) {
        const sessionKey = `stamp_${orderRef}`;
        const sessionData = sessionStorage.getItem(sessionKey);
        
        if (sessionData) {
          try {
            stampData = JSON.parse(sessionData);
            sessionStorage.removeItem(sessionKey); // Clean up
            dataSource = 'session_storage';
            console.log('‚úÖ Recovered from sessionStorage:', stampData.companyName);
          } catch (e) {
            console.error('‚ùå Failed to parse sessionStorage:', e);
          }
        }
      }
      
      // METHOD 2: Try to decode from email field
      if (!stampData && orderRef) {
        const emailParam = urlParams.get('email') || urlParams.get('customer_email');
        if (emailParam && emailParam.includes('#')) {
          const parts = emailParam.split('#');
          if (parts.length >= 2) {
            try {
              const realEmail = parts[0];
              const encodedData = parts[1];
              const decoded = atob(encodedData);
              stampData = JSON.parse(decoded);
              stampData.billingEmail = realEmail; // Restore real email
              dataSource = 'email_encoding';
              console.log('‚úÖ Recovered from email encoding');
            } catch (e) {
              console.error('‚ùå Failed to decode email data:', e);
            }
          }
        }
      }
      
      // METHOD 3: Minimal fallback
      if (!stampData && orderRef) {
        stampData = {
          companyName: 'Company Name Not Recovered',
          orderRef: orderRef,
          timestamp: Date.now()
        };
        dataSource = 'minimal_fallback';
      }
      
      return {
        orderRef: orderRef,
        amount: amount,
        status: status,
        reason: reason,
        stampData: stampData,
        dataSource: dataSource
      };
    }

    // =============================================
    // STAMP GENERATION & DOWNLOAD
    // =============================================

    function generateHDStamp(stampData) {
      if (!stampData) {
        console.error('Cannot generate stamp: No data');
        return null;
      }
      
      try {
        const { companyName, ssmNo, template, color } = stampData;
        
        // Create canvas for HD image
        const canvas = document.createElement('canvas');
        const isHD = true;
        let width, height;
        
        // Set dimensions based on template
        if (template === 'round') {
          width = 1200;
          height = 1200;
        } else if (template === 'box') {
          width = 1200;
          height = 800;
        } else { // info
          width = 1200;
          height = 1000;
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        
        // White background
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, width, height);
        
        // Determine color
        let strokeColor = '#000000';
        if (color === 'red') strokeColor = '#dc2626';
        if (color === 'blue') strokeColor = '#2563eb';
        
        // Center coordinates
        const centerX = width / 2;
        const centerY = height / 2;
        
        if (template === 'round') {
          // Draw round stamp
          const radius = 450;
          ctx.strokeStyle = strokeColor;
          ctx.lineWidth = 12;
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
          ctx.stroke();
          
          // Inner circle
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius * 0.4, 0, Math.PI * 2);
          ctx.stroke();
          
          // Company name (curved - simplified)
          if (companyName) {
            ctx.font = 'bold 72px Arial, sans-serif';
            ctx.fillStyle = strokeColor;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(companyName.toUpperCase(), centerX, centerY - 50);
          }
          
          // SSM number
          if (ssmNo) {
            ctx.font = 'bold 48px Arial, sans-serif';
            ctx.fillText(ssmNo.toUpperCase(), centerX, centerY + 50);
          }
          
        } else {
          // Draw rectangular stamp
          const boxWidth = 900;
          const boxHeight = template === 'box' ? 600 : 800;
          const boxX = (width - boxWidth) / 2;
          const boxY = (height - boxHeight) / 2;
          
          ctx.strokeStyle = strokeColor;
          ctx.lineWidth = 8;
          ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);
          
          // Inner border
          ctx.strokeRect(boxX + 30, boxY + 30, boxWidth - 60, boxHeight - 60);
          
          let yPos = boxY + 120;
          
          // Company name
          if (companyName) {
            ctx.font = 'bold 84px Arial, sans-serif';
            ctx.fillStyle = strokeColor;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText(companyName.toUpperCase(), centerX, yPos);
            yPos += 100;
          }
          
          // SSM number
          if (ssmNo) {
            ctx.font = 'bold 52px Arial, sans-serif';
            ctx.fillText(`SSM: ${ssmNo.toUpperCase()}`, centerX, yPos);
            yPos += 80;
          }
          
          // Additional info for info template
          if (template === 'info' && stampData.address1) {
            ctx.font = '36px Arial, sans-serif';
            ctx.fillText(stampData.address1.toUpperCase(), centerX, yPos);
            yPos += 60;
            
            if (stampData.address2) {
              ctx.fillText(stampData.address2.toUpperCase(), centerX, yPos);
              yPos += 60;
            }
            
            if (stampData.address3) {
              ctx.fillText(stampData.address3.toUpperCase(), centerX, yPos);
              yPos += 60;
            }
          }
        }
        
        // Add "PAID" watermark (subtle)
        ctx.fillStyle = 'rgba(16, 185, 129, 0.05)';
        ctx.font = 'bold 180px Arial, sans-serif';
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(-Math.PI / 6);
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('PAID', 0, 0);
        ctx.restore();
        
        // Add branding
        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        ctx.font = '24px Arial, sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'bottom';
        ctx.fillText('WebStamp.my | Premium HD', width - 20, height - 20);
        
        // Add order reference
        ctx.textAlign = 'left';
        ctx.fillText(`Order: ${stampData.orderRef || ''}`, 20, height - 20);
        
        console.log('‚úÖ HD stamp generated');
        return canvas.toDataURL('image/png');
        
      } catch (error) {
        console.error('‚ùå Error generating stamp:', error);
        return null;
      }
    }

    function downloadHDStamp() {
      if (!currentStampData) {
        alert('Stamp data not found. Please contact support.');
        return false;
      }
      
      const imageData = generateHDStamp(currentStampData);
      
      if (!imageData) {
        alert('Error generating stamp image. Please try again.');
        return false;
      }
      
      try {
        const link = document.createElement('a');
        const fileName = `HD_Stamp_${currentStampData.companyName.replace(/[^a-zA-Z0-9]/g, '_')}_${currentStampData.orderRef || Date.now()}.png`;
        link.download = fileName;
        link.href = imageData;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        
        setTimeout(() => {
          document.body.removeChild(link);
        }, 100);
        
        // Update UI
        document.getElementById('statusMessage').innerHTML = 
          '‚úÖ <strong>HD Stamp downloaded!</strong><br>Check your downloads folder.';
        
        console.log(`‚úÖ Download triggered: ${fileName}`);
        return true;
      } catch (error) {
        console.error('‚ùå Download error:', error);
        alert('Download failed: ' + error.message);
        return false;
      }
    }

    function attemptAutoDownload() {
      if (autoDownloadAttempted || !currentStampData) return;
      
      autoDownloadAttempted = true;
      console.log('Attempting auto-download...');
      
      setTimeout(() => {
        if (downloadHDStamp()) {
          console.log('‚úÖ Auto-download successful');
        } else {
          console.log('‚ùå Auto-download failed');
        }
      }, 1500);
    }

    // =============================================
    // UI FUNCTIONS
    // =============================================

    function updateStatusUI(orderRef, amount, status, reason, stampData, dataSource) {
      // Update basic info
      document.getElementById('orderRef').textContent = orderRef || 'Not found';
      document.getElementById('amount').textContent = 'RM ' + amount;
      document.getElementById('statusText').textContent = status.toUpperCase();
      document.getElementById('dataSource').textContent = dataSource.replace(/_/g, ' ');
      
      // Update email
      const displayEmail = (stampData && stampData.billingEmail) || 
                          (stampData && stampData.email) || 
                          'Not available';
      document.getElementById('customerEmail').textContent = displayEmail;
      
      // Update status card appearance
      const statusCard = document.getElementById('statusCard');
      const statusIcon = document.getElementById('statusIcon');
      const statusTitle = document.getElementById('statusTitle');
      const statusMessage = document.getElementById('statusMessage');
      
      // Hide all action sections
      document.getElementById('successActions').style.display = 'none';
      document.getElementById('failedActions').style.display = 'none';
      document.getElementById('pendingActions').style.display = 'none';
      document.getElementById('errorActions').style.display = 'none';
      
      if (status === 'success' || status === 'completed' || status === 'paid') {
        statusIcon.textContent = '‚úÖ';
        statusIcon.style.color = '#10b981';
        statusIcon.style.animation = 'pulse 2s ease infinite';
        statusTitle.textContent = 'Payment Successful!';
        statusCard.className = 'status-card success';
        
        if (stampData && stampData.companyName) {
          statusMessage.innerHTML = `‚úÖ <strong>Payment Successful!</strong><br>HD stamp for <strong>${stampData.companyName}</strong> is ready.`;
          document.getElementById('successActions').style.display = 'block';
        } else {
          statusMessage.innerHTML = '‚ö†Ô∏è <strong>Payment successful but stamp data not found.</strong>';
          document.getElementById('errorActions').style.display = 'block';
        }
        
      } else if (status === 'failed' || status === 'cancelled') {
        statusIcon.textContent = '‚ùå';
        statusIcon.style.color = '#dc2626';
        statusTitle.textContent = 'Payment Failed';
        statusCard.className = 'status-card failed';
        statusMessage.innerHTML = `‚ùå <strong>Payment Failed</strong><br>${reason ? `Reason: ${reason}` : 'Please try again.'}`;
        document.getElementById('failedActions').style.display = 'block';
        
      } else {
        statusIcon.textContent = '‚è≥';
        statusIcon.style.color = '#f59e0b';
        statusTitle.textContent = 'Processing Payment';
        statusCard.className = 'status-card pending';
        statusMessage.innerHTML = '‚è≥ <strong>Payment Processing</strong><br>Your payment is being verified.';
        document.getElementById('pendingActions').style.display = 'block';
      }
    }

    // =============================================
    // ACTION FUNCTIONS
    // =============================================

    function sendToEmail() {
      if (!currentStampData) {
        alert('Cannot send email: Stamp data not found.');
        return;
      }
      
      const email = currentStampData.billingEmail || currentStampData.email;
      
      if (email && email !== 'Not available') {
        const subject = `Your HD Company Stamp - Order ${currentOrderRef}`;
        const body = `Dear Customer,\n\nThank you for your purchase!\n\nOrder Details:\n- Order Reference: ${currentOrderRef}\n- Company Name: ${currentStampData.companyName || 'N/A'}\n- SSM Number: ${currentStampData.ssmNo || 'N/A'}\n\nYour HD stamp should have downloaded automatically. If not, please visit the download page again.\n\nBest regards,\nWebStamp.my Team`;
        const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        
        window.open(mailtoLink, '_blank');
      } else {
        alert('No email address found. Please contact support.');
      }
    }

    function retryPayment() {
      if (currentStampData) {
        // Encode data for retry
        const encodedData = btoa(JSON.stringify(currentStampData));
        window.location.href = `index.html?retry=${currentOrderRef}&data=${encodedData}`;
      } else {
        window.location.href = 'index.html';
      }
    }

    function checkStatus() {
      // In production, this would verify with payment gateway
      alert('Checking payment status...\n\nPage will refresh.');
      location.reload();
    }

    function contactSupport() {
      const subject = `Stamp Download Issue - Order ${currentOrderRef}`;
      const body = `Hello WebStamp Support,\n\nI completed payment but cannot download my HD stamp.\n\nOrder Reference: ${currentOrderRef}\n\nPlease help me get my stamp!\n\nThank you.`;
      const mailtoLink = `mailto:support@webstamp.my?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      
      window.open(mailtoLink, '_blank');
    }

    // =============================================
    // DEBUG FUNCTIONS
    // =============================================

    function toggleDebug() {
      debugMode = !debugMode;
      const debugEl = document.getElementById('debugInfo');
      debugEl.style.display = debugMode ? 'block' : 'none';
      document.querySelector('.debug-toggle').textContent = 
        debugMode ? 'üîç Hide Debug Info' : 'üîç Show Debug Info';
      
      if (debugMode) {
        updateDebugInfo();
      }
    }

    function updateDebugInfo() {
      const debugEl = document.getElementById('debugInfo');
      const urlParams = new URLSearchParams(window.location.search);
      
      let debugHTML = '<strong>URL Parameters:</strong><br>';
      urlParams.forEach((value, key) => {
        debugHTML += `${key}: ${value}<br>`;
      });
      
      debugHTML += '<br><strong>Stamp Data:</strong><br>';
      if (currentStampData) {
        debugHTML += JSON.stringify(currentStampData, null, 2)
          .replace(/\n/g, '<br>')
          .replace(/ /g, '&nbsp;');
      } else {
        debugHTML += 'No stamp data recovered';
      }
      
      debugEl.innerHTML = debugHTML;
    }

    // =============================================
    // MAIN EXECUTION
    // =============================================

    document.addEventListener('DOMContentLoaded', function() {
      console.log('üéØ Payment Status Page Loaded');
      
      // Extract data from URL and sessionStorage
      const { orderRef, amount, status, reason, stampData, dataSource } = extractStampData();
      
      // Store globally
      currentOrderRef = orderRef;
      currentStampData = stampData;
      
      console.log('üìä Payment Data:', { 
        orderRef, 
        status, 
        hasStampData: !!stampData, 
        dataSource,
        companyName: stampData ? stampData.companyName : 'None'
      });
      
      // Update UI
      updateStatusUI(orderRef, amount, status, reason, stampData, dataSource);
      
      // Handle successful payment
      if (status === 'success' || status === 'completed' || status === 'paid') {
        if (stampData && stampData.companyName) {
          console.log('‚úÖ Payment successful with stamp data');
          
          // Attempt auto-download after 2 seconds
          setTimeout(() => attemptAutoDownload(), 2000);
          
        } else {
          console.log('‚ö†Ô∏è Payment successful but stamp data missing');
        }
      }
    });
  </script>
</body>
</html>
