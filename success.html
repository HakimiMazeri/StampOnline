<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Status - WebStamp.my</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 2rem;
      text-align: center;
    }
    
    .success-icon {
      font-size: 80px;
      margin-bottom: 1.5rem;
      animation: bounce 1s ease infinite alternate;
    }
    
    h1 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #1f2937;
    }
    
    #statusMessage {
      font-size: 1.1rem;
      color: #6b7280;
      margin-bottom: 2rem;
      line-height: 1.6;
    }
    
    .btn {
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      margin: 5px;
    }
    
    .btn-primary {
      background-color: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }
    
    .btn-secondary {
      background-color: #6b7280;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #4b5563;
      transform: translateY(-2px);
    }
    
    .btn-danger {
      background-color: #dc2626;
      color: white;
    }
    
    .btn-danger:hover {
      background-color: #b91c1c;
      transform: translateY(-2px);
    }
    
    .btn-warning {
      background-color: #f59e0b;
      color: white;
    }
    
    .btn-warning:hover {
      background-color: #d97706;
      transform: translateY(-2px);
    }
    
    .status-success { color: #10b981; }
    .status-failed { color: #dc2626; }
    .status-pending { color: #f59e0b; }
    
    .status-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 1.75rem;
      margin: 2.5rem 0;
      border-left: 5px solid #e5e7eb;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      text-align: left;
    }
    
    .status-card.success { 
      border-left-color: #10b981; 
      background: #f0fdf4;
    }
    
    .status-card.failed { 
      border-left-color: #dc2626; 
      background: #fef2f2;
    }
    
    .status-card.pending { 
      border-left-color: #f59e0b; 
      background: #fffbeb;
    }
    
    .detail-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .detail-item:last-child {
      border-bottom: none;
    }
    
    .detail-item span:first-child {
      font-weight: 500;
      color: #4b5563;
    }
    
    .detail-item span:last-child {
      font-weight: 600;
      color: #1f2937;
    }
    
    .footer {
      margin-top: 3rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e5e7eb;
      color: #9ca3af;
      font-size: 0.9rem;
    }
    
    .footer a {
      color: #6366f1;
      text-decoration: none;
      font-weight: 500;
    }
    
    .footer a:hover {
      text-decoration: underline;
    }
    
    .data-warning {
      background: #fff7ed;
      border: 1px solid #fed7aa;
      border-radius: 8px;
      padding: 1rem;
      margin: 1.5rem 0;
      color: #9a3412;
      font-size: 0.95rem;
    }
    
    .debug-info {
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      font-family: monospace;
      font-size: 0.85rem;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    
    .debug-toggle {
      background: transparent;
      border: 1px solid #d1d5db;
      color: #6b7280;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      margin: 0.5rem 0;
    }
    
    .debug-toggle:hover {
      background: #f3f4f6;
    }
    
    @keyframes bounce {
      from { transform: translateY(0px); }
      to { transform: translateY(-10px); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 640px) {
      .container {
        padding: 1.5rem;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .success-icon {
        font-size: 60px;
      }
      
      .btn {
        width: 100%;
        margin: 5px 0;
      }
      
      .status-card {
        padding: 1.25rem;
      }
      
      .detail-item {
        flex-direction: column;
        gap: 0.25rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Status will be dynamically set by JavaScript -->
    <div class="success-icon" id="statusIcon">‚è≥</div>
    <h1 id="statusTitle">Processing Payment...</h1>
    <p id="statusMessage">Checking payment status...</p>
    
    <!-- Debug toggle -->
    <button class="debug-toggle" onclick="toggleDebug()">üîç Show Debug Info</button>
    <div id="debugInfo" class="debug-info"></div>
    
    <!-- Data warning (shown when stamp data is missing) -->
    <div id="dataWarning" class="data-warning" style="display: none;">
      <strong>‚ö†Ô∏è Stamp Data Issue:</strong> Your payment was successful but stamp information was not properly transferred. 
      Please contact support with your Order Reference below.
    </div>
    
    <!-- Order Details Card -->
    <div class="status-card" id="statusCard">
      <div class="detail-item">
        <span>Order Reference:</span>
        <span style="font-family: monospace; font-weight: 600;" id="orderRef">Loading...</span>
      </div>
      <div class="detail-item">
        <span>Customer Email:</span>
        <span id="customerEmail">Loading...</span>
      </div>
      <div class="detail-item">
        <span>Amount:</span>
        <span style="font-weight: 600;" id="amount">Loading...</span>
      </div>
      <div class="detail-item">
        <span>Status:</span>
        <span id="statusText">Loading...</span>
      </div>
      <div class="detail-item">
        <span>Payment Method:</span>
        <span id="paymentMethod">Loading...</span>
      </div>
      <div class="detail-item">
        <span>Data Recovery:</span>
        <span id="recoveryMethod">Checking...</span>
      </div>
    </div>
    
    <!-- Success actions -->
    <div id="successActions" style="display: none;">
      <button onclick="downloadHDStamp()" class="btn btn-primary">
        ‚¨áÔ∏è Download HD Stamp Now
      </button>
      <button onclick="sendToEmail()" class="btn btn-secondary">
        üìß Send to Email
      </button>
      <a href="index.html" class="btn" style="background: #9ca3af; color: white;">
        ‚Üê Back to Home
      </a>
    </div>
    
    <!-- Failed actions -->
    <div id="failedActions" style="display: none;">
      <button onclick="retryPayment()" class="btn btn-danger">
        üîÑ Retry Payment
      </button>
      <a href="index.html" class="btn btn-secondary">
        ‚Üê Back to Home
      </a>
    </div>
    
    <!-- Pending actions -->
    <div id="pendingActions" style="display: none;">
      <p style="color: #6b7280; margin-bottom: 1.5rem;">
        Your payment is being processed. This may take a few minutes.
        <br>This page will automatically update.
      </p>
      <button onclick="checkStatus()" class="btn btn-warning">
        üîÑ Check Status Again
      </button>
      <a href="index.html" class="btn btn-secondary">
        ‚Üê Back to Home
      </a>
    </div>
    
    <!-- Error actions (when stamp data is missing) -->
    <div id="errorActions" style="display: none; margin-top: 2rem;">
      <div style="background: #fee; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <p style="color: #dc2626; margin: 0;">
          <strong>Action Required:</strong> Please contact support with your Order Reference above.
        </p>
      </div>
      <button onclick="contactSupport()" class="btn btn-danger">
        üìû Contact Support Now
      </button>
      <a href="index.html" class="btn btn-secondary">
        ‚Üê Back to Home
      </a>
    </div>
    
    <div class="footer">
      <p>
        Need help? <a href="mailto:support@webstamp.my">Contact Support</a>
        <br><small>WebStamp.my | Secure HD Stamp Generator</small>
      </p>
    </div>
  </div>

  <script>
    // =============================================
    // CONFIGURATION
    // =============================================
    let debugMode = false;
    let autoDownloadAttempted = false;
    let currentStampData = null;
    let currentOrderRef = null;
    
    // =============================================
    // DEBUG FUNCTIONS
    // =============================================
    
    function toggleDebug() {
      debugMode = !debugMode;
      document.getElementById('debugInfo').style.display = debugMode ? 'block' : 'none';
      document.querySelector('.debug-toggle').textContent = debugMode ? 'üîç Hide Debug Info' : 'üîç Show Debug Info';
      
      if (debugMode) {
        updateDebugInfo();
      }
    }
    
    function updateDebugInfo() {
      const debugEl = document.getElementById('debugInfo');
      const urlParams = new URLSearchParams(window.location.search);
      
      let debugHTML = '<strong>URL Parameters:</strong><br>';
      urlParams.forEach((value, key) => {
        debugHTML += `${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}<br>`;
      });
      
      debugHTML += '<br><strong>Stamp Data:</strong><br>';
      if (currentStampData) {
        debugHTML += JSON.stringify(currentStampData, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;');
      } else {
        debugHTML += 'No stamp data recovered';
      }
      
      debugHTML += `<br><br><strong>Local Storage (Stamp Keys):</strong><br>`;
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.includes('stamp') || key.includes('order') || key.includes('last')) {
          const value = localStorage.getItem(key);
          debugHTML += `${key}: ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}<br>`;
        }
      }
      
      debugHTML += `<br><strong>Session Storage Keys:</strong><br>`;
      const keys = Object.keys(sessionStorage);
      keys.forEach(key => {
        if (key.startsWith('stamp_')) {
          debugHTML += `${key}<br>`;
        }
      });
      
      debugEl.innerHTML = debugHTML;
    }
    
    function logDebug(message, data = null) {
      console.log(`[DEBUG] ${message}`, data || '');
      if (debugMode) {
        updateDebugInfo();
      }
    }
    
    // =============================================
    // DATA RECOVERY FUNCTIONS WITH LOCALSTORAGE
    // =============================================
    
    /**
     * Clean up old localStorage entries
     */
    function cleanupOldStorage() {
      const now = Date.now();
      const oneHourAgo = now - 3600000;
      
      // Clean expired stamps
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        
        if (key.startsWith('stamp_exp_')) {
          const expiry = parseInt(localStorage.getItem(key));
          if (expiry < now) {
            const orderRef = key.replace('stamp_exp_', '');
            localStorage.removeItem(key);
            localStorage.removeItem(`stamp_${orderRef}`);
            localStorage.removeItem(`stamp_min_${orderRef}`);
            console.log('üßπ Cleaned expired stamp:', orderRef);
          }
        }
      }
      
      // Clean stamps older than 2 hours (safety)
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        
        if (key.startsWith('stamp_') && !key.includes('exp') && !key.includes('min')) {
          try {
            const data = JSON.parse(localStorage.getItem(key));
            if (data && data.ts && data.ts < oneHourAgo) {
              localStorage.removeItem(key);
              console.log('üßπ Cleaned old stamp:', key);
            }
          } catch (e) {
            localStorage.removeItem(key);
          }
        }
      }
    }
    
    /**
     * Extract stamp data with BCL Embed support
     */
    function extractStampData() {
      logDebug('üîç Starting data extraction...');
      cleanupOldStorage(); // Clean old data first
      
      const urlParams = new URLSearchParams(window.location.search);
      
      // Get URL parameters
      const orderRef = urlParams.get('order_ref') || urlParams.get('order_number');
      const status = urlParams.get('status') || urlParams.get('payment_status') || 'pending';
      const amount = urlParams.get('amount') || '3.00';
      const email = urlParams.get('email') || urlParams.get('customer_email');
      const testMode = urlParams.get('test_mode') === 'true';
      const paymentMethod = urlParams.get('payment_method') || 'bcl_embed';
      const source = urlParams.get('source') || 'url';
      
      logDebug('URL parameters found', { 
        orderRef, 
        status, 
        amount, 
        paymentMethod,
        source,
        email: email ? 'Present' : 'Missing',
        testMode 
      });
      
      // Update payment method display
      document.getElementById('paymentMethod').textContent = paymentMethod.replace(/_/g, ' ');
      
      let stampData = null;
      let recoveryMethod = 'none';
      
      // METHOD 1: Check localStorage by exact order reference (BCL Embed method)
      if (orderRef) {
        logDebug('üíæ Checking localStorage for orderRef:', orderRef);
        const storageKey = `stamp_${orderRef}`;
        const storedData = localStorage.getItem(storageKey);
        
        if (storedData) {
          try {
            stampData = JSON.parse(storedData);
            recoveryMethod = 'local_storage_embed';
            localStorage.removeItem(storageKey); // Clean up
            localStorage.removeItem(`stamp_exp_${orderRef}`);
            localStorage.removeItem(`stamp_min_${orderRef}`);
            logDebug('‚úÖ Recovered from localStorage (embed)', stampData);
          } catch (parseError) {
            logDebug('‚ùå Failed to parse localStorage data', parseError.message);
          }
        }
      }
      
      // METHOD 2: Check if email contains encoded data (legacy BCL redirect)
      if (!stampData && email && email.includes('#')) {
        logDebug('üìß Trying email#data decoding...');
        const parts = email.split('#');
        if (parts.length >= 2) {
          const realEmail = parts[0];
          const encodedData = parts.slice(1).join('#');
          
          try {
            const decodedString = decodeURIComponent(atob(encodedData));
            stampData = JSON.parse(decodedString);
            recoveryMethod = 'email_encoding';
            stampData.e = realEmail;
            logDebug('‚úÖ Successfully decoded from email');
          } catch (decodeError) {
            logDebug('‚ùå Failed to decode email data', decodeError.message);
          }
        }
      }
      
      // METHOD 3: Check localStorage minimal data
      if (!stampData && orderRef) {
        logDebug('üíæ Trying localStorage minimal data...');
        const minKey = `stamp_min_${orderRef}`;
        const minData = localStorage.getItem(minKey);
        
        if (minData) {
          try {
            stampData = JSON.parse(minData);
            recoveryMethod = 'local_storage_minimal';
            localStorage.removeItem(minKey);
            logDebug('‚úÖ Recovered minimal data', stampData);
          } catch (parseError) {
            logDebug('‚ùå Failed to parse minimal data', parseError.message);
          }
        }
      }
      
      // METHOD 4: Check sessionStorage (if same tab)
      if (!stampData && orderRef) {
        logDebug('üíæ Trying sessionStorage...');
        const sessionKey = `stamp_${orderRef}`;
        const sessionData = sessionStorage.getItem(sessionKey);
        
        if (sessionData) {
          try {
            stampData = JSON.parse(sessionData);
            recoveryMethod = 'session_storage';
            sessionStorage.removeItem(sessionKey);
            logDebug('‚úÖ Recovered from sessionStorage', stampData);
          } catch (parseError) {
            logDebug('‚ùå Failed to parse sessionStorage', parseError.message);
          }
        }
      }
      
      // METHOD 5: Check for any recent order in localStorage (fallback)
      if (!stampData) {
        logDebug('üíæ Searching for recent order...');
        const lastOrderRef = localStorage.getItem('last_order_ref');
        
        if (lastOrderRef) {
          const storageKey = `stamp_${lastOrderRef}`;
          const storedData = localStorage.getItem(storageKey);
          
          if (storedData) {
            try {
              stampData = JSON.parse(storedData);
              recoveryMethod = 'local_storage_fallback';
              localStorage.removeItem(storageKey);
              localStorage.removeItem('last_order_ref');
              logDebug('‚úÖ Recovered from fallback', stampData);
            } catch (parseError) {
              logDebug('‚ùå Failed to parse fallback', parseError.message);
            }
          }
        }
      }
      
      // METHOD 6: Test mode
      if (!stampData && testMode) {
        logDebug('üß™ Test mode active');
        stampData = {
          cn: urlParams.get('customer_name') || 'Test Company',
          sn: 'TEST123456',
          t: 'round',
          c: 'black',
          e: email || 'test@example.com',
          ts: Date.now(),
          or: orderRef || 'TEST_' + Date.now()
        };
        recoveryMethod = 'test_mode';
      }
      
      // Expand short property names to full names
      const expandedData = expandStampData(stampData);
      
      if (expandedData && expandedData.companyName) {
        logDebug(`‚úÖ Data recovery successful via ${recoveryMethod}`);
        logDebug('üì¶ Expanded stamp data', expandedData);
        
        // Update recovery method display
        const recoveryEl = document.getElementById('recoveryMethod');
        recoveryEl.textContent = recoveryMethod.replace(/_/g, ' ');
        recoveryEl.style.color = '#10b981';
        recoveryEl.style.fontWeight = '600';
      } else {
        logDebug(`‚ùå Data recovery failed. Method: ${recoveryMethod}`);
        const recoveryEl = document.getElementById('recoveryMethod');
        recoveryEl.textContent = 'Failed';
        recoveryEl.style.color = '#dc2626';
      }
      
      return {
        orderRef: orderRef || (stampData ? stampData.or : ''),
        status: status,
        amount: amount,
        email: email ? email.split('#')[0] : email,
        stampData: expandedData,
        recoveryMethod: recoveryMethod,
        paymentMethod: paymentMethod
      };
    }
    
    /**
     * Expand short property names to full names
     */
    function expandStampData(shortData) {
      if (!shortData) return null;
      
      return {
        companyName: shortData.cn || shortData.companyName || '',
        ssmNo: shortData.sn || shortData.ssmNo || '',
        ssmNoOld: shortData.so || shortData.ssmNoOld || '',
        template: shortData.t || shortData.template || 'round',
        color: shortData.c || shortData.color || 'black',
        email: shortData.e || shortData.email || '',
        phone: shortData.p || shortData.phone || '',
        address: [
          shortData.a1 || shortData.address1 || '',
          shortData.a2 || shortData.address2 || '',
          shortData.a3 || shortData.address3 || ''
        ].filter(addr => addr.trim() !== ''),
        orderRef: shortData.or || shortData.orderRef || '',
        timestamp: shortData.ts || shortData.timestamp || Date.now()
      };
    }
    
    // =============================================
    // STAMP GENERATION FUNCTIONS
    // =============================================
    
    /**
     * Generate stamp image from stamp data
     */
function generateStampImage(stampData) {
  if (!stampData) {
    logDebug('Cannot generate image: No stamp data');
    return null;
  }
  
  try {
    const { companyName, ssmNo, ssmNoOld, template, color, address, phone, email } = stampData;
    
    logDebug('üé® Generating HD stamp image', { companyName, template, color });
    
    // Get text color
    let strokeColor = '#1F2D3D'; // black
    if (color === 'red') strokeColor = '#D33';
    if (color === 'blue') strokeColor = '#1565C0';
    
    const fontFamily = "system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif";
    
    // Build SVG matching the free version EXACTLY
    let svgContent = '';
    let svgWidth = 280;
    let svgHeight = 280;
    
    if (template === 'round') {
      // ROUND STAMP - Matches roundStamp() from main.js
      const text = (companyName || '').toUpperCase();
      const cx = 140, cy = 140, R = 80, step = 10;
      
      // Calculate curved text
      let chars = '';
      const total = (text.length ? text.length - 1 : 0) * step;
      const start = -total / 2;
      
      function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
        const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
        return {
          x: centerX + (radius * Math.cos(angleInRadians)),
          y: centerY + (radius * Math.sin(angleInRadians))
        };
      }
      
      for (let i = 0; i < text.length; i++) {
        const angle = start + i * step;
        const pos = polarToCartesian(cx, cy, R, angle);
        chars += `<text x="${pos.x}" y="${pos.y}" fill="${strokeColor}" font-size="20" font-family="${fontFamily}" font-weight="700" text-anchor="middle" dominant-baseline="middle" transform="rotate(${angle}, ${pos.x}, ${pos.y})">${text[i]}</text>`;
      }
      
      // Center text
      let centerText = '';
      if (ssmNo) {
        centerText += `<text x="${cx}" y="${cy - 8}" font-size="13" text-anchor="middle" fill="${strokeColor}" font-family="${fontFamily}" font-weight="600">${ssmNo.toUpperCase()}</text>`;
      }
      if (ssmNoOld) {
        centerText += `<text x="${cx}" y="${cy + 12}" font-size="13" text-anchor="middle" fill="${strokeColor}" font-family="${fontFamily}" font-weight="600">${ssmNoOld.toUpperCase()}</text>`;
      }
      
      svgContent = `
        <svg width="280" height="280" viewBox="0 0 280 280" xmlns="http://www.w3.org/2000/svg">
          <circle cx="${cx}" cy="${cy}" r="110" stroke="${strokeColor}" stroke-width="6" fill="none" />
          ${chars}
          <circle cx="${cx}" cy="${cy}" r="50" stroke="${strokeColor}" stroke-width="2" fill="none" />
          ${centerText}
        </svg>
      `;
      
    } else if (template === 'box') {
      // BOX STAMP - Matches boxStamp() from main.js
      svgWidth = 320;
      svgHeight = 200;
      const cx = 180;
      const lines = [];
      
      if (companyName) lines.push({
        text: companyName.toUpperCase(),
        size: 22,
        weight: 700
      });
      if (ssmNo) lines.push({
        text: ssmNo.toUpperCase(),
        size: 14,
        weight: 600,
        extraGap: 8
      });
      (address || []).forEach(line => {
        if (line && line.trim()) lines.push({
          text: line.toUpperCase(),
          size: 13,
          weight: 500
        });
      });
      
      const totalHeight = lines.length * 20 + lines.reduce((acc, l) => acc + (l.extraGap || 0), 0);
      const startY = (220 - totalHeight) / 2 + 20;
      
      let y = startY;
      const textElements = lines.map(l => {
        const element = `<text x="${cx}" y="${y}" font-size="${l.size}" fill="${strokeColor}" font-family="${fontFamily}" font-weight="${l.weight}" text-anchor="middle">${l.text}</text>`;
        y += 20 + (l.extraGap || 0);
        return element;
      }).join('');
      
      svgContent = `
        <svg width="320" height="200" viewBox="0 0 360 220" xmlns="http://www.w3.org/2000/svg">
          <rect x="8" y="8" width="344" height="204" stroke="${strokeColor}" stroke-width="3" fill="none" rx="4" />
          ${textElements}
        </svg>
      `;
      
    } else if (template === 'info') {
      // INFO STAMP - Matches infoStamp() from main.js
      svgWidth = 320;
      svgHeight = 260;
      const cx = 180;
      const lines = [];
      
      if (companyName) lines.push({
        text: companyName.toUpperCase(),
        size: 22,
        weight: 700
      });
      if (ssmNo) lines.push({
        text: ssmNo.toUpperCase(),
        size: 14,
        weight: 600,
        extraGap: 8
      });
      (address || []).forEach(line => {
        if (line && line.trim()) lines.push({
          text: line.toUpperCase(),
          size: 13,
          weight: 500
        });
      });
      if (phone) lines.push({
        text: phone,
        size: 13,
        weight: 500,
        extraGap: 8
      });
      if (email) lines.push({
        text: email.toLowerCase(),
        size: 13,
        weight: 500
      });
      
      const totalHeight = lines.length * 20 + lines.reduce((acc, l) => acc + (l.extraGap || 0), 0);
      const startY = (260 - totalHeight) / 2 + 20;
      
      let y = startY;
      const textElements = lines.map(l => {
        const element = `<text x="${cx}" y="${y}" font-size="${l.size}" fill="${strokeColor}" font-family="${fontFamily}" font-weight="${l.weight}" text-anchor="middle">${l.text}</text>`;
        y += 20 + (l.extraGap || 0);
        return element;
      }).join('');
      
      svgContent = `
        <svg width="320" height="260" viewBox="0 0 360 260" xmlns="http://www.w3.org/2000/svg">
          <rect x="8" y="8" width="344" height="244" stroke="${strokeColor}" stroke-width="3" fill="none" rx="4" />
          ${textElements}
        </svg>
      `;
    }
    
    // Create HD canvas (3x resolution for high quality)
    const scale = 3;
    const canvas = document.createElement('canvas');
    canvas.width = svgWidth * scale;
    canvas.height = svgHeight * scale;
    const ctx = canvas.getContext('2d');
    
    // White background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Convert SVG to image and draw on canvas
    const svgBlob = new Blob([svgContent], {type: 'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(svgBlob);
    
    return new Promise((resolve, reject) => {
      const img = new Image();
      
      img.onload = function() {
        // Draw the stamp at HD resolution
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      };
      
      img.onerror = function() {
        URL.revokeObjectURL(url);
        logDebug('‚ùå Error loading SVG image');
        reject(new Error('Failed to load stamp image'));
      };
      
      img.src = url;
    });
    
  } catch (error) {
    logDebug('‚ùå Error generating stamp image', error);
    return null;
  }
}

/**
 * Updated downloadStampImage function to work with Promise
 * Replace the existing downloadStampImage function
 */
function downloadStampImage(stampData) {
  if (!stampData || !stampData.companyName) {
    logDebug('Cannot download: Invalid stamp data');
    alert('Error: Stamp data is incomplete. Please contact support.');
    return false;
  }
  
  const imagePromise = generateStampImage(stampData);
  
  if (!imagePromise) {
    logDebug('Image generation failed');
    alert('Error generating stamp image. Please try again.');
    return false;
  }
  
  imagePromise.then(imageData => {
    try {
      const link = document.createElement('a');
      const fileName = `HD_Stamp_${stampData.companyName.replace(/[^a-zA-Z0-9]/g, '_')}_${stampData.orderRef || Date.now()}.png`;
      link.download = fileName;
      link.href = imageData;
      link.style.display = 'none';
      
      document.body.appendChild(link);
      link.click();
      
      setTimeout(() => {
        document.body.removeChild(link);
      }, 100);
      
      logDebug(`‚úÖ Download triggered: ${fileName}`);
      return true;
    } catch (error) {
      logDebug('‚ùå Download error', error);
      alert('Download failed: ' + error.message);
      return false;
    }
  }).catch(error => {
    logDebug('‚ùå Image generation error', error);
    alert('Error generating stamp image. Please try again.');
    return false;
  });
}
    
    /**
     * Attempt auto-download
     */
    function attemptAutoDownload(stampData) {
      if (autoDownloadAttempted) {
        logDebug('Auto-download already attempted, skipping');
        return;
      }
      
      autoDownloadAttempted = true;
      logDebug('Starting auto-download attempt...');
      
      // Update status message
      const statusMessage = document.getElementById('statusMessage');
      statusMessage.innerHTML = 'üîÑ <strong>Generating your HD stamp...</strong><br>Your download will start in 2 seconds.';
      
      setTimeout(() => {
        if (downloadStampImage(stampData)) {
          statusMessage.innerHTML = '‚úÖ <strong>HD Stamp downloaded!</strong><br>Check your downloads folder.';
          
          // Show download instructions
          setTimeout(() => {
            const instructions = document.createElement('div');
            instructions.style.marginTop = '10px';
            instructions.style.fontSize = '0.9rem';
            instructions.style.color = '#6b7280';
            instructions.style.fontStyle = 'italic';
            
            const isChrome = /Chrome/.test(navigator.userAgent);
            const isFirefox = /Firefox/.test(navigator.userAgent);
            
            if (isChrome) {
              instructions.innerHTML = 'üí° <strong>Note:</strong> Check the bottom of Chrome or press Ctrl+J';
            } else if (isFirefox) {
              instructions.innerHTML = 'üí° <strong>Note:</strong> Check downloads panel or press Ctrl+J';
            } else {
              instructions.innerHTML = 'üí° <strong>Note:</strong> Check your Downloads folder';
            }
            
            statusMessage.appendChild(instructions);
          }, 1000);
        } else {
          statusMessage.innerHTML = '‚ö†Ô∏è <strong>Auto-download failed</strong><br>Please use the "Download HD Stamp Now" button below.';
        }
      }, 2000);
    }
    
    // =============================================
    // MAIN EXECUTION
    // =============================================
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üéØ Payment Status Page Loaded');
      console.log('üîß Running data recovery...');
      
      // Extract data with localStorage support
      const { orderRef, status, amount, email, stampData, recoveryMethod, paymentMethod } = extractStampData();
      
      // Store globally
      currentOrderRef = orderRef;
      currentStampData = stampData;
      
      logDebug('Main execution data', { 
        orderRef, 
        status, 
        hasStampData: !!stampData, 
        recoveryMethod,
        paymentMethod,
        stampPreview: stampData ? `${stampData.companyName} (${stampData.template})` : 'None'
      });
      
      // Update UI
      updateStatusUI(orderRef, status, amount, email, stampData, recoveryMethod, paymentMethod);
      
      // Handle successful payment
      if (status === 'success' || status === 'completed' || status === 'paid') {
        if (stampData && stampData.companyName) {
          logDebug('‚úÖ Payment successful with stamp data');
          
          // Show company name
          document.getElementById('statusMessage').innerHTML = 
            `‚úÖ <strong>Payment Successful!</strong><br>HD stamp for <strong>${stampData.companyName}</strong> is ready.`;
          
          // Enable download buttons
          document.getElementById('successActions').style.display = 'block';
          
          // Auto-download attempt after 1.5 seconds
          setTimeout(() => attemptAutoDownload(stampData), 1500);
          
        } else {
          logDebug('‚ö†Ô∏è Payment successful but stamp data missing');
          showDataMissingError(orderRef, stampData);
        }
      } else if (status === 'failed' || status === 'cancelled') {
        logDebug('‚ùå Payment failed or cancelled');
        // Failed UI already handled by updateStatusUI
      } else {
        logDebug('‚è≥ Payment pending or unknown status');
        // Pending UI already handled by updateStatusUI
      }
    });
    
    // =============================================
    // UI FUNCTIONS
    // =============================================
    
    function updateStatusUI(orderRef, status, amount, email, stampData, recoveryMethod, paymentMethod) {
      // Update order info
      document.getElementById('orderRef').textContent = orderRef || 'Not found';
      document.getElementById('amount').textContent = 'RM ' + amount;
      document.getElementById('statusText').textContent = status.toUpperCase();
      document.getElementById('paymentMethod').textContent = paymentMethod ? paymentMethod.replace(/_/g, ' ') : 'BCL Embed';
      
      // Determine email to show
      const displayEmail = email || 
                          (stampData && stampData.email) || 
                          'Not available';
      document.getElementById('customerEmail').textContent = displayEmail;
      
      // Status-specific UI
      const statusCard = document.getElementById('statusCard');
      const statusIcon = document.getElementById('statusIcon');
      const statusTitle = document.getElementById('statusTitle');
      
      // Hide all actions initially
      document.getElementById('successActions').style.display = 'none';
      document.getElementById('failedActions').style.display = 'none';
      document.getElementById('pendingActions').style.display = 'none';
      document.getElementById('errorActions').style.display = 'none';
      document.getElementById('dataWarning').style.display = 'none';
      
      if (status === 'success' || status === 'completed' || status === 'paid') {
        statusIcon.textContent = '‚úÖ';
        statusIcon.style.color = '#10b981';
        statusIcon.style.animation = 'pulse 2s ease infinite';
        statusTitle.textContent = 'Payment Successful!';
        statusCard.className = 'status-card success';
        
        // Add recovery method indicator
        if (recoveryMethod && recoveryMethod !== 'none') {
          const recoveryNote = document.createElement('div');
          recoveryNote.style.fontSize = '0.8rem';
          recoveryNote.style.color = '#6b7280';
          recoveryNote.style.marginTop = '5px';
          recoveryNote.textContent = `Data recovered via: ${recoveryMethod.replace(/_/g, ' ')}`;
          document.getElementById('statusMessage').appendChild(recoveryNote);
        }
        
      } else if (status === 'failed' || status === 'cancelled') {
        statusIcon.textContent = '‚ùå';
        statusIcon.style.color = '#dc2626';
        statusTitle.textContent = 'Payment Failed';
        statusCard.className = 'status-card failed';
        document.getElementById('failedActions').style.display = 'block';
        
      } else {
        statusIcon.textContent = '‚è≥';
        statusIcon.style.color = '#f59e0b';
        statusTitle.textContent = 'Processing Payment';
        statusCard.className = 'status-card pending';
        document.getElementById('pendingActions').style.display = 'block';
      }
    }
    
    function showDataMissingError(orderRef, partialData) {
      logDebug('Showing data missing error');
      
      document.getElementById('dataWarning').style.display = 'block';
      document.getElementById('errorActions').style.display = 'block';
      document.getElementById('successActions').style.display = 'none';
      
      let errorMessage = 'Payment successful but stamp design data was not fully recovered. ';
      
      if (partialData && partialData.companyName) {
        errorMessage += `We found partial data: ${partialData.companyName}. `;
      }
      
      errorMessage += 'Please contact support with your order reference.';
      
      document.getElementById('statusMessage').innerHTML = 
        `‚ö†Ô∏è <strong>${errorMessage}</strong><br>Order: ${orderRef}`;
    }
    
    function showError(message) {
      document.getElementById('statusIcon').textContent = '‚ùå';
      document.getElementById('statusIcon').style.color = '#dc2626';
      document.getElementById('statusTitle').textContent = 'Error';
      document.getElementById('statusMessage').innerHTML = `<strong>Error:</strong> ${message}`;
      document.getElementById('statusCard').style.display = 'none';
      document.getElementById('errorActions').style.display = 'block';
    }
    
    // =============================================
    // ACTION FUNCTIONS
    // =============================================
    
    function downloadHDStamp() {
      logDebug('Manual download triggered by user');
      
      if (!currentStampData) {
        alert('Stamp data not found. Please contact support with your order reference.');
        return;
      }
      
      // Update status message
      document.getElementById('statusMessage').innerHTML = 
        'üîÑ <strong>Generating your HD stamp...</strong>';
      
      if (downloadStampImage(currentStampData)) {
        document.getElementById('statusMessage').innerHTML = 
          '‚úÖ <strong>HD Stamp downloaded!</strong><br>Check your downloads folder.';
      }
    }
    
    function sendToEmail() {
      if (!currentStampData) {
        alert('Cannot send email: Stamp data not found.');
        return;
      }
      
      const email = currentStampData.email || document.getElementById('customerEmail').textContent;
      
      if (email && email !== 'Not available') {
        const subject = `Your HD Company Stamp - Order ${currentOrderRef}`;
        const body = `Dear Customer,\n\nThank you for your purchase!\n\nOrder Details:\n- Order Reference: ${currentOrderRef}\n- Company Name: ${currentStampData.companyName || 'N/A'}\n- SSM Number: ${currentStampData.ssmNo || 'N/A'}\n\nYour HD stamp should have downloaded automatically. If not, please visit the download page again.\n\nBest regards,\nWebStamp.my Team`;
        const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        
        window.open(mailtoLink, '_blank');
      } else {
        alert('No email address found. Please contact support.');
      }
    }
    
    function retryPayment() {
      if (currentStampData) {
        const encodedData = btoa(encodeURIComponent(JSON.stringify(currentStampData)));
        window.location.href = `index.html?retry_order=${currentOrderRef}&data=${encodedData}`;
      } else {
        window.location.href = 'index.html';
      }
    }
    
    function checkStatus() {
      alert('Checking payment status...\n\nIn production, this would verify with payment gateway.');
      location.reload();
    }
    
    function contactSupport() {
      const subject = `Stamp Download Issue - Order ${currentOrderRef}`;
      const body = `Hello WebStamp Support,\n\nI completed payment but cannot download my HD stamp.\n\nOrder Reference: ${currentOrderRef}\n\nPlease help me get my stamp!\n\nThank you.`;
      const mailtoLink = `mailto:support@webstamp.my?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      
      window.open(mailtoLink, '_blank');
    }
    
    // =============================================
    // TEST FUNCTION FOR DEVELOPMENT
    // =============================================
    
    window.testRecovery = function() {
      console.log('üß™ Testing data recovery...');
      
      // Simulate BCL return with test data
      const testData = {
        cn: "TEST COMPANY SDN BHD",
        sn: "202401234567",
        t: "round",
        c: "black",
        e: "test@example.com",
        ts: Date.now(),
        or: "TEST_" + Date.now()
      };
      
      // Save to localStorage
      localStorage.setItem(`stamp_${testData.or}`, JSON.stringify(testData));
      localStorage.setItem('last_order_ref', testData.or);
      
      // Simulate redirect
      const encoded = btoa(JSON.stringify(testData));
      window.location.href = `success.html?status=success&order_ref=${testData.or}&customer_email=test@example.com#${encoded}&test_mode=true`;
    };
  </script>
</body>
</html>

